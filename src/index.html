<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>FF XIV Auctioneer v.1.0.0 @Konbuscus</title>

    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="css/index.css">

 <!-- jQuery CDN - Slim version (=without AJAX) -->
 <script>let $ = require('jquery');</script>
 <script>require('popper.js');</script>
 <script>require('bootstrap');</script>
 <script src="js/xivapi/xivapi.js"></script>
 
 


</head>

<body>
    <div class="wrapper">
        <!-- Sidebar  -->
        <nav id="sidebar">
            <div class="sidebar-header">
                    <img src="../res/ffxivauctioneer.png"/>
                <h3>FF XIV Auctioneer</h3>
            </div>

            <ul class="list-unstyled components">
                <p class="startingPoint">Items categories</p>
            </ul>
        </nav>

        <!-- Page Content  -->
        <div id="content">

            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    
                    <button type="button" id="sidebarCollapse" class="btn btn-dark">
                        <span>Hide menu</span>
                    </button>
                    <button type="button" id="btnApiKey" class="btn btn-dark">
                            <i class="fas fa-key"></i>
                            <span></span>
                        </button>

                </div>
            </nav>
            <div class="items-details">

                    <div class="line"></div>
                    <h2 class="categoryTitle"></h2>
                    <div class="container row">
                        <div class="col col-lg-3">
                            <table>
                                <tbody class="items-container">
    
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-9 elfamosochart">
                                
                            </div>
                    </div>
                    
            </div>
            
        </div>
    </div>

    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h5 class="modal-title w-100 font-weight-bold">Enter a valid API KEY</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <i class="fas fa-envelope prefix grey-text"></i>
          <input type="text" id="apiKey" class="form-control validate">
          <label data-error="wrong" data-success="right" for="apiKey"><a target="_blank" href="https://xivapi.com">Need API KEY ?</a></label>
        </div>
        <button id="validApi" class="btn btn-dark">SAVE</button>
      </div>
    </div>
  </div>
</div>


   

    <script type="text/javascript">
    var Chart = require('chart.js');
    var Datastore = require('nedb'), db = new Datastore({ filename: 'src/main.db', autoload: true });
    // You can issue commands right away
    var apiKey;
    var dc = "";
    var itemid = "";
    var itemname = "";

        $(document).ready(function () {
            
            $("#modal").modal("show");

            //Chargement des cat√©gories ...
            // db.find({}, function (err, docs) {
            //     if(docs.length == 0){
            //     }
            // });            
            popDataCenter();
            LoadSideBar();
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
                var buttonSpan = $(this).find("span");
                if($("#sidebar").hasClass("active")){
                    $(buttonSpan).text("Display menu");
                }else{
                    $(buttonSpan).text("Hide menu");
                }
            });

            $("#validApi").on("click", function(){
                var key = $("#apiKey").val();
                apiKey = key;
                doc = {
                    apiKey: key,
                    current: 0
                };
                db.remove({}, { multi: true }, function(err, doc) {  
                console.log('Deleted', doc);
                });
                db.insert(doc, function (err, newDoc) {   // Callback is optional
                // newDoc is the newly inserted document, including its _id
                // newDoc has no key called notToBeSaved since its value was undefined
                });
                if(apiKey != ""){
                    $("button").attr("disabled", false);
                }
                $("#modal").modal("hide");
            });

            $("#btnApiKey").on("click", function(){
                $("#modal").modal("show");
            });
            
        });



         async function LoadSideBar(){

            var categoriesArray = await getCategories();
            var startingPoint = document.querySelector("p.startingPoint");

            for(var i = 0; i < categoriesArray.length; i++){
                
                var category = categoriesArray[i];
                //var itemsCategory = await getItemsByCategory(category.ID);

                var cateogryMinus = categoriesArray[i-1];
                //Adding entry in menu
                var iterateHtml = $("<li id='"+category.ID+"'> <a href='#"+category.ID+"Submenu' data-toggle='collpse' id='"+category.ID+"' class='dropdown-toggle' onclick='LoadItemList(this.id)'>" + category.Name_en + " <img src='"+category.Icon+"' /> </a> <ul class='collapse list-unstyled' id='"+category.Name_en+"Submenu'> </ul></li>");
                
                //First entry after the starting point, other after the category index -1
                if(i == 0){
                    $(iterateHtml).insertAfter($(startingPoint));
                }else{
                    var previousEntry = document.querySelector("li[id='"+ cateogryMinus.ID +"']");
                    $(iterateHtml).insertAfter($(previousEntry));
                }
            }
        }

         async function LoadItemList(categoryID){
            
            
            $("li").removeClass("active");
            var clickedElement = document.querySelector("a[id='"+categoryID+"']").parentElement;
            $(clickedElement).addClass("active");
            const items = await getItemsByCategory(categoryID);
            var divToLoad = $("table tbody.items-container");
            $(divToLoad).html("");
            for(var i = 0; i < items.length; i++){
                var itemHtml = $("<tr onclick='GenerateChart(this.id, this.children[0].innerHTML)' id='"+items[i].ID+"'><td>"+items[i].Name+"</td><td><img src='"+items[i].Icon+"'/></td> </tr>");
                $(itemHtml).appendTo($(divToLoad));
            }
            //To the top
            $(window).scrollTop(0);
        }

        async function GenerateChart(itemID, itemName){

            var dcName = dc;
            itemid = itemID;
            itemname = itemName;
            $("canvas").remove();
            $("div.elfamosochart").append("<canvas id='chart' width='800' height='600'> </canvas>")
            var chart = document.getElementById("chart").getContext("2d");
            
            //Getting item info
            var itemInfo = await getItemPrices(itemID, dcName);
            var data = dataProcessing(itemInfo);
            var options = {
            title: {
            display: true,
            text: 'History prices of item ' + itemName + ' on Datacenter : ' + dcName + ""
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                    }
                }],
                },
        }
            var zChart = new Chart(chart,{type:"line", data: data,options});
        }



        function dataProcessing(itemInfo){
            
            var data = {
                labels: [],
                datasets:[]
            };

            for(var i in itemInfo){

                var historyData = [];
                var timestampData = [];
                itemInfo[i].Prices.sort((a, b) => (a.Added > b.Added) ? 1 : -1) 
                itemInfo[i].History.sort((a, b) => (a.Added > b.Added) ? 1 : -1)

                var finalData = itemInfo[i].History.concat(itemInfo[i].Prices);
                finalData.forEach(function(element){
                    historyData.push(element.PricePerUnit);
                    timestampData.push(new Date(element.Added * 1000).toLocaleString());
                });
                data.labels = timestampData;
                data.datasets.push({

                    label:i,
                    backgroundColor: random_rgba(),
                    data: historyData

                });

            }
            return data;
            
        }

    function random_rgba() {
    var o = Math.round, r = Math.random, s = 255;
    return 'rgba(' + o(r()*s) + ',' + o(r()*s) + ',' + o(r()*s) + ',' + r().toFixed(1) + ')';
    }

    async function popDataCenter(){

        var whereToInsert = $("button#btnApiKey");
        var datacenters = await getDataCenterList();

        for(var i = 0; i < datacenters.length; i++){

            var html = $("<button id='"+datacenters[i]+"' class='btn btn-dark' disabled onclick='applyDatacenter(this.id)'>"+datacenters[i]+"</button>");
            $(html).insertAfter($(whereToInsert));
        }
    }

    function applyDatacenter(dcName){
        dc = dcName;
        //Reload chart if already here
        var currChart = document.getElementById("chart");
        if(currChart != undefined){
            GenerateChart(itemid, itemname);
        }
    }

    </script>

</body>

</html>